<?php
$apiKey = Mage::getStoreConfig('payment/easycredit/api_key');
?>
<script>
(function($) {

    /**
     *
     * @param {string} price
     * @returns {Number}
     */
    var getPriceAsFloat = function (price) {
        var separatorComa,
            separatorDot;

        price = price.replace(/[^\d.,-]/g,'');

        separatorComa = price.indexOf(',');
        separatorDot = price.indexOf('.');

        if (separatorComa > -1 && separatorDot > -1) {
            if (separatorComa > separatorDot) {
                price = price.replace(/\./g, '');
                price = price.replace(',', '.');
            } else {
                price = price.replace(/,/g, '');
            }
        }  else if (separatorComa > -1) {
            price = price.replace(',', '.');
        }

        return parseFloat(price);
    };

    var getSelector = function() {
        selectors = [
            '#product_addtocart_form .price-box .special-price .price-including-tax .price',
            '#product_addtocart_form .price-box .price-including-tax .price',
            '#product_addtocart_form .price-box .special-price .price',
            '#product_addtocart_form .price-box .regular-price .price'
        ];

        var _selector = null;
        $.each(selectors,function(index,selector){
            if ($(selector).length > 0) {
                _selector = selector;
                return false;
            }
        });
        return _selector;
    }
    selector = getSelector();

    var applyWidget = function() {
        var me = this;
        var priceBox = $(this).closest('.price-box');

        var amount = function() {
            return getPriceAsFloat($(me).html().stripTags());
        }();

        if (isNaN(amount)) {
            return;
        }

        if (priceBox.find('easycredit-widget').length === 0) {
            priceBox.append('<easycredit-widget webshop-id="<?php echo $apiKey; ?>" amount="' + amount + '" />');
            return;
        }
        priceBox.find('easycredit-widget').attr('amount', amount);
    }; 

    $(selector)
        .each(applyWidget)
        .on('DOMSubtreeModified propertychange', applyWidget)
        ;

}(jQuery));
</script>
